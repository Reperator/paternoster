- name: drop script
  become: yes
  copy:
    dest: /usr/local/bin/uberspace-unittest
    mode: 0775
    content: "{{ script }}"

- name: drop playbook
  become: yes
  copy:
    dest: /opt/uberspace/playbooks/uberspace-unittest.yml
    content: "{{ playbook|default('') }}"

- name: sudoers config
  become: yes
  template: src=../templates/sudoers.j2 dest=/etc/sudoers.d/uberspace-unittest
  vars:
    item: uberspace-unittest

- shell: uberspace-unittest {{ script_params|default('') }}
  become_user: testy
  register: script

- name: delete script, playbook and sudoers config
  become: yes
  file:
    name: "{{ item }}"
    state: absent
  with_items:
    - /usr/local/bin/uberspace-unittest
    - /opt/uberspace/playbooks/uberspace-unittest.yml
    - /etc/sudoers.d/uberspace-unittest
